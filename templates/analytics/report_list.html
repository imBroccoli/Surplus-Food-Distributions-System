{% extends 'base.html' %}
{% load static %}

{% block title %}{{ report_type|title }} Reports{% endblock %}

{% block extra_css %}
<style>
    /* Reset any previous dropdown fix attempts */
    .dropdown-menu {
        position: absolute;
        max-height: none;
        overflow: visible;
        z-index: 1050;
    }
    
    /* Define a new styles for our custom dropdown solution */
    .action-cell {
        min-width: 220px; /* Ensure cell is wide enough */
        position: relative;
    }
    
    .action-cell .btn {
        margin-right: 2px;
    }

    /* Custom dropdown menu */
    .custom-dropdown {
        display: inline-block;
        vertical-align: middle;
    }
    
    /* Dropdown content styles */
    .custom-dropdown-menu {
        position: fixed; /* Use fixed positioning */
        display: none;
        background-color: white;
        min-width: 160px;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border-radius: 0.25rem;
        border: 1px solid rgba(0, 0, 0, 0.15);
        z-index: 9999;
        padding: 0.5rem 0;
    }
    
    .custom-dropdown-menu a {
        display: block;
        padding: 0.5rem 1rem;
        color: #212529;
        text-decoration: none;
        white-space: nowrap;
    }
    
    .custom-dropdown-menu a:hover {
        background-color: #f8f9fa;
    }
    
    /* Clean up button group styling */
    .btn-group {
        display: inline-flex !important;
    }
    
    /* Show custom dropdown */
    .custom-dropdown-menu.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ report_type|title }} Reports</h1>
        <div>
            <a href="{% url 'analytics:generate_report' %}?type={{ report_type|upper }}" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> New Report
            </a>
            <a href="{% url 'analytics:reports_dashboard' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <ul class="nav nav-pills card-header-pills">
                <li class="nav-item">
                    <a class="nav-link {% if not current_filter %}active{% endif %}" href="{% url 'analytics:report_list' report_type=report_type %}">All Reports</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if current_filter == 'scheduled' %}active{% endif %}" href="{% url 'analytics:report_list' report_type=report_type %}?status=scheduled">Scheduled</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if current_filter == 'one-time' %}active{% endif %}" href="{% url 'analytics:report_list' report_type=report_type %}?status=one-time">One-time</a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            {% if reports %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Date Generated</th>
                                <th>Generated By</th>
                                <th>Status</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in reports %}
                                <tr>
                                    <td><a href="{% url 'analytics:report_detail' report_id=report.id %}">{{ report.title }}</a></td>
                                    <td>{{ report.date_generated|date:"M d, Y" }}</td>
                                    <td>{{ report.generated_by.get_full_name|default:report.generated_by.email }}</td>
                                    <td>
                                        {% if report.is_scheduled %}
                                            <span class="badge bg-info text-dark">
                                                <i class="fas fa-clock"></i> {{ report.get_schedule_frequency_display }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-file-alt"></i> One-time
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center action-cell">
                                        <div class="d-inline-flex">
                                            <a href="{% url 'analytics:report_detail' report_id=report.id %}" 
                                               class="btn btn-sm btn-outline-primary" title="View Report">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button class="btn btn-sm btn-outline-success regenerate-btn" data-report-id="{{ report.id }}" title="Regenerate Report">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                            {% if report.is_scheduled %}
                                                <button type="button" class="btn btn-sm btn-outline-warning unschedule-btn" data-report-id="{{ report.id }}" title="Unschedule Report">
                                                    <i class="fas fa-clock-slash"></i>
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-sm btn-outline-info schedule-btn" data-report-id="{{ report.id }}" title="Schedule Report">
                                                    <i class="fas fa-clock"></i>
                                                </button>
                                            {% endif %}
                                            
                                            <!-- Custom download dropdown solution -->
                                            <div class="custom-dropdown">
                                                <button type="button" class="btn btn-sm btn-outline-info custom-dropdown-toggle"
                                                        data-report-id="{{ report.id }}" title="Download">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <div class="custom-dropdown-menu" id="dropdown-menu-{{ report.id }}">
                                                    <a href="{% url 'analytics:export_report' report_id=report.id export_format='pdf' %}">
                                                        <i class="far fa-file-pdf text-danger me-2"></i> PDF
                                                    </a>
                                                    <a href="{% url 'analytics:export_report' report_id=report.id export_format='csv' %}">
                                                        <i class="far fa-file-csv text-success me-2"></i> CSV
                                                    </a>
                                                    <a href="{% url 'analytics:export_report' report_id=report.id export_format='excel' %}">
                                                        <i class="far fa-file-excel text-primary me-2"></i> Excel
                                                    </a>
                                                </div>
                                            </div>
                                            
                                            <form action="{% url 'analytics:delete_report' report_id=report.id %}" method="post" class="d-inline delete-form">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Report">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if reports.has_other_pages %}
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if reports.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if current_filter %}&status={{ current_filter }}{% endif %}" aria-label="First">
                                        <span aria-hidden="true">&laquo;&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ reports.previous_page_number }}{% if current_filter %}&status={{ current_filter }}{% endif %}" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="First">
                                        <span aria-hidden="true">&laquo;&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                            {% endif %}
                            
                            {% for num in reports.paginator.page_range %}
                                {% if reports.number == num %}
                                    <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                                {% elif num > reports.number|add:'-3' and num < reports.number|add:'3' %}
                                    <li class="page-item"><a class="page-link" href="?page={{ num }}{% if current_filter %}&status={{ current_filter }}{% endif %}">{{ num }}</a></li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if reports.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ reports.next_page_number }}{% if current_filter %}&status={{ current_filter }}{% endif %}" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ reports.paginator.num_pages }}{% if current_filter %}&status={{ current_filter }}{% endif %}" aria-label="Last">
                                        <span aria-hidden="true">&raquo;&raquo;</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="Last">
                                        <span aria-hidden="true">&raquo;&raquo;</span>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
                
            {% else %}
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-chart-bar fa-4x text-muted"></i>
                    </div>
                    <h5>No reports available</h5>
                    <p class="text-muted">Generate a new {{ report_type|title }} report to see it here.</p>
                    <a href="{% url 'analytics:generate_report' %}?type={{ report_type|upper }}" class="btn btn-primary mt-3">
                        <i class="fas fa-plus-circle"></i> Generate Report
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scheduleModalLabel">Schedule Report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="scheduleForm">
          <div class="mb-3">
            <label for="frequency" class="form-label">Frequency</label>
            <select class="form-select" id="frequency" required>
              <option value="">Select frequency</option>
              <option value="DAILY">Daily</option>
              <option value="WEEKLY">Weekly</option>
              <option value="MONTHLY">Monthly</option>
              <option value="QUARTERLY">Quarterly</option>
            </select>
          </div>
          <div class="mb-3" id="timeField">
            <label for="scheduleTime" class="form-label">Time</label>
            <input type="time" class="form-control" id="scheduleTime" value="09:00" required>
            <small class="text-muted">Select time for report generation</small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveSchedule">Schedule</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Custom dropdown implementation
        const dropdownToggles = document.querySelectorAll('.custom-dropdown-toggle');
        
        // Close all dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.custom-dropdown')) {
                const allMenus = document.querySelectorAll('.custom-dropdown-menu');
                allMenus.forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });
        
        // Toggle dropdown when clicking the button
        dropdownToggles.forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Close all other dropdowns
                const allMenus = document.querySelectorAll('.custom-dropdown-menu');
                allMenus.forEach(menu => {
                    menu.classList.remove('show');
                });
                
                const reportId = this.getAttribute('data-report-id');
                const dropdownMenu = document.getElementById(`dropdown-menu-${reportId}`);
                
                // Position the dropdown properly
                const buttonRect = this.getBoundingClientRect();
                
                // Check if dropdown would go off screen to the right
                const menuWidth = 160; // Approximate width of dropdown
                const rightEdge = buttonRect.right + menuWidth;
                const viewportWidth = window.innerWidth;
                
                if (rightEdge > viewportWidth) {
                    // Position to the left of button
                    dropdownMenu.style.left = (buttonRect.left - menuWidth) + 'px';
                } else {
                    // Position to the right of button
                    dropdownMenu.style.left = buttonRect.left + 'px';
                }
                
                dropdownMenu.style.top = (buttonRect.bottom + window.scrollY + 2) + 'px';
                dropdownMenu.classList.toggle('show');
            });
        });
        
        // Get CSRF token for all AJAX requests
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
        
        // Helper function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Get bootstrap modal element
        const scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'), {
            keyboard: true,
            backdrop: 'static'
        });
        
        let currentReportId = null;
        
        // Schedule report functionality
        document.querySelectorAll('.schedule-btn').forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                const reportId = this.getAttribute('data-report-id');
                currentReportId = reportId;
                
                // Reset form
                document.getElementById('scheduleForm').reset();
                document.getElementById('frequency').value = '';
                document.getElementById('scheduleTime').value = '09:00';
                
                // Show the modal
                scheduleModal.show();
            });
        });
        
        // Handle frequency change to show/hide time field
        document.getElementById('frequency').addEventListener('change', function() {
            const timeField = document.getElementById('timeField');
            // Always show time field
            timeField.style.display = 'block';
        });
        
        // Handle save button click
        document.getElementById('saveSchedule').addEventListener('click', function() {
            const frequency = document.getElementById('frequency').value;
            const scheduleTime = document.getElementById('scheduleTime').value;
            
            if (!frequency) {
                alert('Please select a frequency');
                return;
            }
            
            // Create form data for submission
            const formData = new FormData();
            formData.append('frequency', frequency);
            if (scheduleTime) {
                formData.append('schedule_time', scheduleTime);
            }
            
            // Show loading indicator
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Scheduling...';
            
            // Send request to server
            fetch(`/analytics/reports/${currentReportId}/schedule/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                // Hide modal
                scheduleModal.hide();
                
                if (data.status === 'success') {
                    // Show success message with sweetify if available
                    if (typeof sweetify !== 'undefined') {
                        sweetify.success(data.message || 'Report scheduled successfully');
                    } else {
                        alert('Report scheduled successfully');
                    }
                    
                    // Refresh the page to show updated status
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    // Show error message
                    if (typeof sweetify !== 'undefined') {
                        sweetify.error(data.message || 'Failed to schedule report');
                    } else {
                        alert(data.message || 'Failed to schedule report');
                    }
                    
                    // Reset button
                    this.disabled = false;
                    this.innerHTML = 'Schedule';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Hide modal
                scheduleModal.hide();
                
                // Show error message
                if (typeof sweetify !== 'undefined') {
                    sweetify.error('An error occurred while scheduling the report');
                } else {
                    alert('An error occurred while scheduling the report');
                }
                
                // Reset button
                this.disabled = false;
                this.innerHTML = 'Schedule';
            });
        });
        
        // Unschedule report functionality 
        document.querySelectorAll('.unschedule-btn').forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                const reportId = this.getAttribute('data-report-id');
                const btn = this;
                
                sweetify.fire({
                    title: 'Unschedule Report',
                    text: 'Are you sure you want to remove the scheduling for this report?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, unschedule it',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#d33',
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show loading indicator
                        btn.disabled = true;
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                        
                        // Create form data for submission
                        const formData = new FormData();
                        formData.append('frequency', 'UNSCHEDULE');
                        
                        // Send request to server
                        fetch(`/analytics/reports/${reportId}/schedule/`, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': csrfToken
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                sweetify.success(data.message || 'Report unscheduled successfully');
                                
                                // Refresh the page to show updated status
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1000);
                            } else {
                                sweetify.error(data.message || 'Failed to unschedule report');
                                
                                // Reset button
                                btn.disabled = false;
                                btn.innerHTML = '<i class="fas fa-clock-slash"></i>';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            
                            sweetify.error('An error occurred while unscheduling the report');
                            
                            // Reset button
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-clock-slash"></i>';
                        });
                    }
                });
            });
        });
        
        // Handle regenerate button with better feedback
        document.querySelectorAll('.regenerate-btn').forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                const reportId = this.getAttribute('data-report-id');
                const originalHTML = this.innerHTML;
                const button = this;
                
                // Confirm before regenerating with Sweetify
                sweetify.fire({
                    title: 'Regenerate Report',
                    text: 'Are you sure you want to regenerate this report with fresh data?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, regenerate it',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#3085d6',
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Disable button and show spinner
                        button.disabled = true;
                        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                        
                        // Create form data for CSRF token
                        const formData = new FormData();
                        
                        // Send POST request to the server
                        fetch(`/analytics/reports/${reportId}/regenerate/`, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': csrfToken
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // Show success message
                                sweetify.success(data.message || 'Report regenerated successfully');
                                
                                // Refresh the page after a short delay to show updated report
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            } else {
                                // Show error message
                                sweetify.error(data.message || 'Failed to regenerate report');
                                
                                // Reset button
                                button.disabled = false;
                                button.innerHTML = originalHTML;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            // Show error message
                            sweetify.error('An unexpected error occurred while regenerating the report');
                            
                            // Reset button
                            button.disabled = false;
                            button.innerHTML = originalHTML;
                        });
                    }
                });
            });
        });
        
        // Handle delete form submission
        document.querySelectorAll('.delete-form').forEach(function(form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const form = this;
                const deleteButton = form.querySelector('button[type="submit"]');
                const originalHTML = deleteButton.innerHTML;
                
                sweetify.fire({
                    title: 'Delete Report',
                    text: 'Are you sure you want to delete this report? This action cannot be undone.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete it',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#d33',
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Disable button and show spinner
                        if (deleteButton) {
                            deleteButton.disabled = true;
                            deleteButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                        }
                        
                        // Get form data and CSRF token
                        const formData = new FormData(form);
                        
                        fetch(form.action, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // Show success message
                                sweetify.success('Report deleted successfully');
                                
                                // Force immediate redirect to reports dashboard
                                window.location.href = '{% url "analytics:reports_dashboard" %}';
                            } else {
                                // If there's an error, restore the button and show error message
                                if (deleteButton) {
                                    deleteButton.disabled = false;
                                    deleteButton.innerHTML = originalHTML;
                                }
                                
                                sweetify.error(data.message || 'Error deleting report');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            // Restore the button
                            if (deleteButton) {
                                deleteButton.disabled = false;
                                deleteButton.innerHTML = originalHTML;
                            }
                            
                            sweetify.error('An unexpected error occurred while deleting the report');
                        });
                    }
                });
            });
        });
    });
</script>
{% endblock %}